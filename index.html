<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>agent-v0</title>

  <style>
    body { font-family: Arial; margin: 2rem; color:#111;}
    .status { font-weight:700;}
    .ok { color:#0a7a0a;}
    .err { color:#b00020;}
    input { padding:0.5rem; width:380px; margin-right:10px;}
    button { padding:0.5rem;}
    pre { margin-top:1rem; background:#fafafa; padding:1rem; border-radius:6px;}
    .row { margin-bottom:0.75rem; }
  </style>
</head>

<body>

<h1>agent-v0</h1>
<p>Frontend deployed on Vercel.</p>

<p>
Backend API check:
<span id="apiStatus" class="status">checkingâ€¦</span>
</p>

<hr/>

<h2>Backend config</h2>
<div class="row">
  <input id="apiUrl" placeholder="Backend API URL" />
</div>
<div class="row">
  <input id="apiSecret" placeholder="x-agent-secret" />
</div>
<div class="row">
  <button onclick="saveConfig()">Save config</button>
  <button onclick="checkApi()">Re-check API</button>
</div>

<hr/>

<h2>Test your agent</h2>

<input id="question" placeholder="Ask something..." />
<button onclick="askAgent()">Send</button>

<pre id="response"></pre>

<script>
const DEFAULT_API_URL = "https://agent-backend-six.vercel.app/api/agent";
const API_URL_KEY = "agent_v0_api_url";
const API_SECRET_KEY = "agent_v0_api_secret";

function getConfig() {
  const apiUrlInput = document.getElementById("apiUrl");
  const apiSecretInput = document.getElementById("apiSecret");
  return {
    apiUrl: apiUrlInput.value.trim(),
    secret: apiSecretInput.value.trim()
  };
}

function loadConfig() {
  const savedUrl = localStorage.getItem(API_URL_KEY);
  const savedSecret = localStorage.getItem(API_SECRET_KEY);
  document.getElementById("apiUrl").value = savedUrl || DEFAULT_API_URL;
  document.getElementById("apiSecret").value = savedSecret || "";
}

function saveConfig() {
  const { apiUrl, secret } = getConfig();
  localStorage.setItem(API_URL_KEY, apiUrl);
  localStorage.setItem(API_SECRET_KEY, secret);
  checkApi();
}

async function checkApi() {
  const el = document.getElementById("apiStatus");
  const { apiUrl, secret } = getConfig();
  el.classList.remove("ok", "err");

  if (!apiUrl) {
    el.textContent = "backend URL missing";
    el.classList.add("err");
    return;
  }

  if (!secret) {
    el.textContent = "secret missing";
    el.classList.add("err");
    return;
  }

  try {
    const res = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-agent-secret": secret
      },
      body: JSON.stringify({
        messages: [{ role:"user", content:"ping"}]
      })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status} ${res.statusText} | ${text.slice(0, 180)}`);
    }

    el.textContent = "connected";
    el.classList.add("ok");

  } catch (err) {
    el.textContent = `not reachable (${err.message})`;
    el.classList.add("err");
  }
}


async function askAgent() {

  const responseBox = document.getElementById("response");
  const question = document.getElementById("question").value.trim();
  const { apiUrl, secret } = getConfig();

  if (!question) {
    responseBox.textContent = "Please enter a question.";
    return;
  }

  if (!apiUrl || !secret) {
    responseBox.textContent = "Configure backend URL and secret first.";
    return;
  }

  responseBox.textContent = "Thinking...";

  try {
    const res = await fetch(apiUrl, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-agent-secret": secret
      },
      body: JSON.stringify({
        messages:[
          { role:"user", content:question }
        ]
      })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status} ${res.statusText} | ${text.slice(0, 180)}`);
    }

    const data = await res.json();

    responseBox.textContent =
      data.response || JSON.stringify(data, null, 2);

  } catch (err) {
    responseBox.textContent = `Error calling agent: ${err.message}`;
  }
}

loadConfig();
checkApi();
</script>

</body>
</html>
