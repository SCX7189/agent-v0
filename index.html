<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IA Visibility Lab</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-0: #0b0d10;
      --bg-1: #12161b;
      --panel: #161b22;
      --panel-soft: #1b212b;
      --line: rgba(255, 255, 255, 0.12);
      --ink: #eceff3;
      --muted: #a8b0bb;
      --brand: #ff7a00;
      --brand-2: #ff8d29;
      --ok: #2ac28f;
      --err: #ff5a5a;
      --fact: #7ea7ff;
      --hyp: #ffb75d;
      --unk: #c08cff;
      --radius: 14px;
      --shadow: 0 18px 42px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Avenir Next", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(65vw 32vw at -10% -5%, rgba(126, 167, 255, 0.16) 0%, transparent 62%),
        radial-gradient(55vw 36vw at 110% 100%, rgba(255, 122, 0, 0.14) 0%, transparent 60%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
      min-height: 100vh;
      padding: 16px;
    }

    .app {
      max-width: 1420px;
      margin: 0 auto;
      display: grid;
      gap: 14px;
    }

    .topbar {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(22, 27, 34, 0.85);
      backdrop-filter: blur(7px);
      box-shadow: var(--shadow);
      padding: 14px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }

    .brand-title {
      margin: 0;
      font-size: 26px;
      letter-spacing: 0.01em;
      color: #d2d8e0;
    }

    .brand-sub {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .view-switch {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      border: 1px solid var(--line);
      background: var(--panel-soft);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 999px;
      cursor: pointer;
      font: inherit;
      font-size: 13px;
      font-weight: 600;
    }

    .pill.active {
      background: var(--brand);
      color: #111;
      border-color: var(--brand);
    }

    .workspace {
      display: grid;
      grid-template-columns: 330px minmax(420px, 1fr) 360px;
      gap: 14px;
      align-items: start;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
    }

    .left-col {
      display: grid;
      gap: 12px;
      position: sticky;
      top: 16px;
    }

    .section {
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .section h2 {
      margin: 0;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #9ea5af;
      font-weight: 600;
    }

    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 5px;
    }

    input, textarea, select, button {
      width: 100%;
      font: inherit;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #10151c;
      color: var(--ink);
    }

    input, select { padding: 10px 11px; }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: rgba(126, 167, 255, 0.8);
      box-shadow: 0 0 0 3px rgba(126, 167, 255, 0.14);
    }

    textarea {
      resize: vertical;
      min-height: 96px;
      max-height: 260px;
      padding: 12px;
      line-height: 1.42;
    }

    button {
      padding: 10px 11px;
      cursor: pointer;
      background: var(--brand);
      color: #111;
      border-color: var(--brand);
      font-weight: 600;
      transition: background 0.2s ease, transform 0.16s ease;
    }

    button:hover {
      background: var(--brand-2);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #121923;
      color: #d7dce4;
      border-color: var(--line);
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .status { font-weight: 700; color: var(--muted); }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); }

    .mini-note {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .trend-box {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #121923;
      padding: 8px;
      display: grid;
      gap: 8px;
      min-height: 88px;
    }

    .trend-status {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .trend-row {
      display: grid;
      grid-template-columns: 90px 1fr auto;
      gap: 7px;
      align-items: center;
      font-size: 12px;
    }

    .trend-key {
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .trend-bar {
      height: 8px;
      border-radius: 999px;
      background: #2a3544;
      overflow: hidden;
    }

    .trend-bar > span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, #7ea7ff, #ff7a00);
    }

    .trend-meta { font-size: 11px; color: var(--muted); }

    .chat-shell {
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      min-height: 78vh;
      overflow: hidden;
    }

    .chat-head {
      border-bottom: 1px solid var(--line);
      padding: 14px;
      display: grid;
      gap: 6px;
      background: linear-gradient(180deg, #1a2029, #151b23);
    }

    .chat-head strong { font-size: 17px; }

    .starters {
      border-bottom: 1px solid var(--line);
      padding: 10px 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .starter {
      width: auto;
      border-radius: 999px;
      font-size: 12px;
      padding: 7px 10px;
      background: #111923;
      color: #d0d7e2;
      border-color: #2a3544;
    }

    .thread {
      padding: 14px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: linear-gradient(180deg, #10151c, #0f141b);
    }

    .bubble {
      max-width: 90%;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 11px;
      white-space: pre-wrap;
      line-height: 1.4;
      font-size: 14px;
      animation: fadeIn .2s ease;
    }

    .bubble.user {
      align-self: flex-end;
      background: #1e2834;
      border-color: #2c3a4c;
    }

    .bubble.assistant {
      align-self: flex-start;
      background: #151c25;
    }

    .assistant-rich {
      display: grid;
      gap: 7px;
    }

    .assistant-h1 {
      margin: 2px 0 4px;
      font-size: 19px;
      line-height: 1.2;
      font-weight: 700;
      color: #d9dee7;
    }

    .assistant-h2 {
      margin: 6px 0 2px;
      font-size: 15px;
      line-height: 1.25;
      color: #b9c0cb;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .assistant-p {
      margin: 0;
      line-height: 1.45;
    }

    .line-tag {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      vertical-align: middle;
      letter-spacing: 0.02em;
    }

    .line-tag.fact { background: rgba(126, 167, 255, 0.2); color: #b8d2ff; }
    .line-tag.hyp { background: rgba(255, 183, 93, 0.2); color: #ffd29b; }
    .line-tag.unk { background: rgba(192, 140, 255, 0.2); color: #debeff; }

    .composer {
      border-top: 1px solid var(--line);
      padding: 12px;
      display: grid;
      gap: 8px;
      background: #131922;
    }

    .right-col {
      display: grid;
      gap: 12px;
      position: sticky;
      top: 16px;
    }

    .mode-title {
      margin: 0;
      font-size: 18px;
    }

    .mode-sub {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 12px;
    }

    .list {
      display: grid;
      gap: 8px;
    }

    .progress-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 7px;
    }

    .stat-chip {
      border: 1px solid var(--line);
      border-radius: 9px;
      padding: 8px 7px;
      text-align: center;
      background: #111923;
    }

    .stat-chip b {
      display: block;
      font-size: 16px;
      line-height: 1;
    }

    .stat-chip span {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .stepper {
      display: grid;
      gap: 6px;
      max-height: 360px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .step-item {
      width: 100%;
      text-align: left;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #111923;
      color: var(--ink);
      padding: 8px 9px;
      font-size: 12px;
      line-height: 1.25;
      font-weight: 600;
    }

    .step-item.active {
      border-color: var(--brand);
      box-shadow: inset 0 0 0 1px var(--brand);
      background: rgba(255, 122, 0, 0.13);
    }

    .item {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 9px;
      background: #111923;
      font-size: 13px;
      line-height: 1.35;
    }

    .item.fact { border-left: 4px solid var(--fact); }
    .item.hyp { border-left: 4px solid var(--hyp); }
    .item.unk { border-left: 4px solid var(--unk); }

    .muted-empty {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .tech-trace {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      white-space: normal;
      max-height: 220px;
      overflow-y: auto;
      border: 1px dashed var(--line);
      border-radius: 10px;
      padding: 8px;
      background: #111923;
    }

    .tech-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px dashed #ddd3c3;
      padding: 4px 0;
    }

    .tech-row:last-child { border-bottom: 0; }
    .tech-key { color: #8d98a8; font-weight: 600; }
    .tech-value { color: #dee4ee; text-align: right; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 1180px) {
      .workspace { grid-template-columns: 300px 1fr; }
      .right-col { grid-column: span 2; position: static; grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 900px) {
      body { padding: 12px; }
      .workspace { grid-template-columns: 1fr; }
      .left-col, .right-col { position: static; }
      .right-col { grid-template-columns: 1fr; }
      .chat-shell { min-height: 64vh; }
      .topbar { grid-template-columns: 1fr; }
      .view-switch { justify-content: flex-start; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div>
        <h1 class="brand-title">IA Visibility Lab</h1>
        <p class="brand-sub">Audit decisionnel assiste IA: preuves, scenarios, decisions.</p>
      </div>
      <div class="view-switch" id="viewSwitch">
        <button class="pill active" data-view="diagnostic">Diagnostic</button>
        <button class="pill" data-view="scenarios">Scenarios</button>
        <button class="pill" data-view="decision">Decision</button>
      </div>
    </header>

    <div class="workspace">
      <aside class="left-col">
        <section class="card section">
          <h2>Etat API</h2>
          <div id="apiStatus" class="status">verification...</div>
        </section>

        <section class="card section">
          <h2>Configuration</h2>
          <div>
            <label for="apiUrl">Backend URL</label>
            <input id="apiUrl" placeholder="https://.../api/agent" />
          </div>
          <div>
            <label for="apiSecret">x-agent-secret</label>
            <input id="apiSecret" placeholder="Ton secret" />
          </div>
          <div>
            <label for="detailMode">Mode de reponse</label>
            <select id="detailMode">
              <option value="long">Long (recommande)</option>
              <option value="short">Court</option>
            </select>
          </div>
          <div class="btn-row">
            <button onclick="saveConfig()">Save config</button>
            <button class="btn-secondary" onclick="checkApi()">Re-check API</button>
          </div>
          <div class="btn-row">
            <button class="btn-secondary" onclick="clearConversation()">Reset conversation</button>
          </div>
        </section>

        <section class="card section">
          <h2>Market Signals</h2>
          <label for="trendKeywords">Mots-cles (auto IA)</label>
          <input id="trendKeywords" placeholder="manomano, leroy merlin, castorama" />
          <p class="mini-note">L'IA met a jour les mots-cles a chaque question. Tu peux les modifier.</p>
          <div class="btn-row">
            <button onclick="refreshTrends()">Charger tendances</button>
          </div>
          <div class="trend-box">
            <div id="trendStatus" class="trend-status">en attente...</div>
            <div id="trendResults"></div>
          </div>
        </section>
      </aside>

      <main class="card chat-shell">
        <div class="chat-head">
          <strong>Conversation strategique</strong>
          <p class="mini-note">Contexte persistant + enrichissement automatique des signaux marche.</p>
        </div>

        <div class="starters" id="starters"></div>

        <section id="thread" class="thread"></section>

        <div class="composer">
          <textarea id="question" placeholder="Pose ta question (diagnostic, risques, decisions, plan d'action)..."></textarea>
          <div class="btn-row">
            <button onclick="askAgent()">Envoyer</button>
            <button class="btn-secondary" onclick="clearInput()">Effacer</button>
          </div>
          <p class="mini-note">Ctrl/Cmd + Entree pour envoyer.</p>
        </div>
      </main>

      <aside class="right-col">
        <section class="card section">
          <div>
            <h3 id="modeTitle" class="mode-title">Diagnostic</h3>
            <p id="modeSub" class="mode-sub">Vue structuree de la derniere reponse.</p>
          </div>
          <div id="progressStats" class="progress-stats"></div>
          <div id="sectionStepper" class="stepper"></div>
        </section>

        <section class="card section">
          <h2>Trace technique</h2>
          <div id="techTrace" class="tech-trace">Aucune execution pour le moment.</div>
        </section>
      </aside>
    </div>
  </div>

  <script>
    const DEFAULT_API_URL = "https://agent-backend-six.vercel.app/api/agent";
    const API_URL_KEY = "agent_v0_api_url";
    const API_SECRET_KEY = "agent_v0_api_secret";
    const DETAIL_MODE_KEY = "agent_v0_detail_mode";
    const TREND_KEYWORDS_KEY = "agent_v0_trend_keywords";
    const CHAT_HISTORY_KEY = "agent_v0_chat_history";
    const SESSION_ID_KEY = "agent_v0_session_id";
    const MAX_HISTORY_MESSAGES = 20;

    const STARTERS = [
      "Fais un diagnostic strategic de notre position IA sur 12 mois.",
      "Quels sont nos 3 risques critiques et les signaux d'alerte associes ?",
      "Propose 3 options de decision COMEX avec trade-offs explicites.",
      "Construis un memo board-ready en 1 page sur notre priorite IA.",
      "Fais un Red Team de notre plan actuel avec hypotheses concurrentes."
    ];

    let history = [];
    let sessionId = "";
    let currentView = "diagnostic";
    let lastResponseText = "";
    let lastRenderedSections = [];

    function generateSessionId() {
      if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
        return crypto.randomUUID();
      }
      return `session-${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
    }

    function loadSessionId() {
      const existing = localStorage.getItem(SESSION_ID_KEY);
      if (existing) {
        sessionId = existing;
        return;
      }
      sessionId = generateSessionId();
      localStorage.setItem(SESSION_ID_KEY, sessionId);
    }

    function getConfig() {
      return {
        apiUrl: document.getElementById("apiUrl").value.trim(),
        secret: document.getElementById("apiSecret").value.trim(),
        detailMode: document.getElementById("detailMode").value,
        trendKeywords: document.getElementById("trendKeywords").value.trim()
      };
    }

    function loadConfig() {
      const savedUrl = localStorage.getItem(API_URL_KEY);
      const savedSecret = localStorage.getItem(API_SECRET_KEY);
      const savedDetailMode = localStorage.getItem(DETAIL_MODE_KEY);
      const savedTrendKeywords = localStorage.getItem(TREND_KEYWORDS_KEY);
      document.getElementById("apiUrl").value = savedUrl || DEFAULT_API_URL;
      document.getElementById("apiSecret").value = savedSecret || "";
      document.getElementById("detailMode").value = savedDetailMode || "long";
      document.getElementById("trendKeywords").value = savedTrendKeywords || "manomano, leroy merlin, castorama";
    }

    function saveConfig() {
      const { apiUrl, secret, detailMode, trendKeywords } = getConfig();
      localStorage.setItem(API_URL_KEY, apiUrl);
      localStorage.setItem(API_SECRET_KEY, secret);
      localStorage.setItem(DETAIL_MODE_KEY, detailMode);
      localStorage.setItem(TREND_KEYWORDS_KEY, trendKeywords);
      checkApi();
    }

    function getTrendsApiUrl(apiUrl) {
      if (!apiUrl) return "";
      if (/\/api\/agent\/?$/.test(apiUrl)) return apiUrl.replace(/\/api\/agent\/?$/, "/api/market-signals");
      if (/\/api\/?$/.test(apiUrl)) return `${apiUrl.replace(/\/$/, "")}/market-signals`;
      return `${apiUrl.replace(/\/$/, "")}/api/market-signals`;
    }

    function getKeywordSuggestApiUrl(apiUrl) {
      if (!apiUrl) return "";
      if (/\/api\/agent\/?$/.test(apiUrl)) return apiUrl.replace(/\/api\/agent\/?$/, "/api/keyword-suggest");
      if (/\/api\/?$/.test(apiUrl)) return `${apiUrl.replace(/\/$/, "")}/keyword-suggest`;
      return `${apiUrl.replace(/\/$/, "")}/api/keyword-suggest`;
    }

    function loadHistory() {
      const raw = localStorage.getItem(CHAT_HISTORY_KEY);
      if (!raw) {
        history = [];
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          history = parsed.filter((m) => m && (m.role === "user" || m.role === "assistant") && typeof m.content === "string");
          const latestAssistant = [...history].reverse().find((m) => m.role === "assistant");
          lastResponseText = latestAssistant ? latestAssistant.content : "";
        }
      } catch {
        history = [];
      }
    }

    function saveHistory() {
      localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history.slice(-MAX_HISTORY_MESSAGES)));
    }

    function clearConversation() {
      history = [];
      sessionId = generateSessionId();
      localStorage.setItem(SESSION_ID_KEY, sessionId);
      saveHistory();
      renderThread();
      renderInsights();
      document.getElementById("techTrace").textContent = "Aucune execution pour le moment.";
    }

    function clearInput() {
      document.getElementById("question").value = "";
    }

    function appendMessage(role, content) {
      history.push({ role, content });
      history = history.slice(-MAX_HISTORY_MESSAGES);
      saveHistory();
      renderThread();
    }

    function escapeHtml(text) {
      return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function cleanMarkdownInline(text) {
      return String(text || "")
        .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, "$1")
        .replace(/\*\*([^*]+)\*\*/g, "$1")
        .replace(/\*([^*\n]+)\*/g, "$1")
        .replace(/`([^`]+)`/g, "$1")
        .replace(/\s{2,}/g, " ")
        .trim();
    }

    function normalizeDisplayLine(input) {
      let line = cleanMarkdownInline(input || "");
      line = line
        .replace(/^#{1,6}\s+/u, "")
        .replace(/^[0-9]\uFE0F?\u20E3\s*/u, "")
        .replace(/^\d+[.)]\s+/u, "")
        .replace(/^[-*+]\s+/u, "")
        .replace(/^\s*[-•]\s+/u, "")
        .replace(/\s{2,}/g, " ")
        .trim();
      return line;
    }

    function splitStatusTag(line) {
      const raw = normalizeDisplayLine(line);
      if (raw.includes("[Fact")) return { clean: cleanMarkdownInline(raw.replace(/\[Fact[^\]]*\]/gi, "")), tagClass: "fact", tagLabel: "Fact" };
      if (raw.includes("[Hypothesis")) return { clean: cleanMarkdownInline(raw.replace(/\[Hypothesis[^\]]*\]/gi, "")), tagClass: "hyp", tagLabel: "Hypothesis" };
      if (raw.includes("[Unknown")) return { clean: cleanMarkdownInline(raw.replace(/\[Unknown[^\]]*\]/gi, "")), tagClass: "unk", tagLabel: "Unknown" };
      if (/\bFact\b$/i.test(raw)) return { clean: cleanMarkdownInline(raw.replace(/\bFact\b$/i, "")), tagClass: "fact", tagLabel: "Fact" };
      if (/\bHypothesis\b$/i.test(raw)) return { clean: cleanMarkdownInline(raw.replace(/\bHypothesis\b$/i, "")), tagClass: "hyp", tagLabel: "Hypothesis" };
      if (/\bUnknown\b$/i.test(raw)) return { clean: cleanMarkdownInline(raw.replace(/\bUnknown\b$/i, "")), tagClass: "unk", tagLabel: "Unknown" };
      return { clean: raw.trim(), tagClass: "", tagLabel: "" };
    }

    function formatAssistantLine(rawLine) {
      const raw = String(rawLine || "").trim();
      const parsed = splitStatusTag(rawLine);
      let line = parsed.clean || rawLine.trim();
      let klass = "assistant-p";

      if (/^##\s+/.test(raw) || /^\d+[.)]\s+/.test(raw) || /^[0-9]\uFE0F?\u20E3/.test(raw)) {
        klass = "assistant-h2";
      } else if (/^#\s+/.test(raw)) {
        klass = "assistant-h1";
      }

      line = normalizeDisplayLine(line);
      if (!line) return "";

      const tagHtml = parsed.tagClass ? `<span class="line-tag ${parsed.tagClass}">${parsed.tagLabel}</span>` : "";
      if (klass === "assistant-h1") return `<h1 class="${klass}">${escapeHtml(line)}${tagHtml}</h1>`;
      if (klass === "assistant-h2") return `<h2 class="${klass}">${escapeHtml(line)}${tagHtml}</h2>`;
      return `<p class="${klass}">${escapeHtml(line)}${tagHtml}</p>`;
    }

    function formatAssistantContent(content) {
      const lines = String(content || "").split(/\n+/).map((l) => l.trim()).filter(Boolean);
      if (lines.length === 0) return "<p class=\"assistant-p\"></p>";
      const rendered = lines.map((line) => formatAssistantLine(line)).filter(Boolean).join("");
      return `<div class=\"assistant-rich\">${rendered || "<p class='assistant-p'></p>"}</div>`;
    }

    function formatInsightText(line) {
      const parsed = splitStatusTag(line);
      if (!parsed.tagLabel) return parsed.clean;
      return `${parsed.clean} (${parsed.tagLabel})`;
    }

    function buildSectionListFromText(text) {
      const lines = String(text || "").split("\n").map((l) => String(l || "").trim()).filter(Boolean);
      const sections = [];
      for (const rawLine of lines) {
        const heading = rawLine.match(/^#{1,3}\s+(.+)$/);
        if (heading && heading[1]) {
          sections.push(normalizeDisplayLine(heading[1]));
          continue;
        }

        const numbered = rawLine.match(/^(\d+[.)]|[0-9]\uFE0F?\u20E3)\s*(.+)$/u);
        if (numbered && numbered[2]) {
          sections.push(normalizeDisplayLine(numbered[2]));
        }
      }
      return [...new Set(sections.filter(Boolean))].slice(0, 14);
    }

    function renderStepperFromLatestBubble() {
      const container = document.getElementById("sectionStepper");
      container.innerHTML = "";

      const thread = document.getElementById("thread");
      const richNodes = thread.querySelectorAll(".bubble.assistant .assistant-rich");
      const latest = richNodes[richNodes.length - 1];

      if (!latest) {
        const empty = document.createElement("p");
        empty.className = "muted-empty";
        empty.textContent = "Aucune section detectee.";
        container.appendChild(empty);
        return;
      }

      const headings = Array.from(latest.querySelectorAll(".assistant-h1, .assistant-h2"));
      if (headings.length === 0) {
        const fallback = lastRenderedSections.length > 0 ? lastRenderedSections : ["Section unique"];
        fallback.forEach((label, index) => {
          const btn = document.createElement("button");
          btn.className = "step-item";
          btn.textContent = `${index + 1}. ${label}`;
          btn.onclick = () => {
            thread.scrollTop = 0;
          };
          container.appendChild(btn);
        });
        return;
      }

      headings.forEach((el, idx) => {
        el.id = `assistant-sec-${idx}`;
        const btn = document.createElement("button");
        btn.className = "step-item";
        btn.dataset.target = el.id;
        btn.textContent = `${idx + 1}. ${cleanMarkdownInline(el.textContent)}`;
        btn.onclick = () => {
          el.scrollIntoView({ behavior: "smooth", block: "start" });
          updateActiveStep();
        };
        container.appendChild(btn);
      });

      updateActiveStep();
    }

    function updateActiveStep() {
      const container = document.getElementById("sectionStepper");
      const items = Array.from(container.querySelectorAll(".step-item[data-target]"));
      if (items.length === 0) return;

      let bestId = items[0].dataset.target;
      let minDistance = Number.POSITIVE_INFINITY;

      for (const item of items) {
        const targetId = item.dataset.target;
        if (!targetId) continue;
        const el = document.getElementById(targetId);
        if (!el) continue;
        const distance = Math.abs(el.getBoundingClientRect().top - 150);
        if (distance < minDistance) {
          minDistance = distance;
          bestId = targetId;
        }
      }

      items.forEach((item) => {
        item.classList.toggle("active", item.dataset.target === bestId);
      });
    }

    function renderThread() {
      const thread = document.getElementById("thread");
      thread.innerHTML = "";
      if (history.length === 0) {
        const empty = document.createElement("p");
        empty.className = "muted-empty";
        empty.textContent = "Aucune conversation pour le moment. Utilise un starter ou pose une question.";
        thread.appendChild(empty);
        return;
      }
      for (const message of history) {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${message.role}`;
        if (message.role === "assistant") {
          bubble.innerHTML = formatAssistantContent(message.content);
        } else {
          bubble.textContent = message.content;
        }
        thread.appendChild(bubble);
      }
      thread.scrollTop = thread.scrollHeight;
      renderStepperFromLatestBubble();
    }

    function renderStarters() {
      const container = document.getElementById("starters");
      container.innerHTML = "";
      for (const text of STARTERS) {
        const btn = document.createElement("button");
        btn.className = "starter";
        btn.textContent = text;
        btn.onclick = () => {
          document.getElementById("question").value = text;
          askAgent();
        };
        container.appendChild(btn);
      }
    }

    function renderTrends(data) {
      const target = document.getElementById("trendResults");
      target.innerHTML = "";
      const series = Array.isArray(data?.series) ? data.series : [];
      if (series.length === 0) {
        target.textContent = "Aucune donnee.";
        return;
      }
      for (const item of series) {
        const row = document.createElement("div");
        row.className = "trend-row";

        const key = document.createElement("div");
        key.className = "trend-key";
        key.textContent = item.keyword || "-";

        const bar = document.createElement("div");
        bar.className = "trend-bar";
        const fill = document.createElement("span");
        const width = Math.max(2, Math.min(100, Number(item.latest || 0)));
        fill.style.width = `${width}%`;
        bar.appendChild(fill);

        const meta = document.createElement("div");
        meta.className = "trend-meta";
        const delta = Number(item.delta || 0);
        const arrow = delta > 0 ? "↑" : delta < 0 ? "↓" : "→";
        meta.textContent = `${arrow} ${Number(item.latest || 0)}`;

        row.appendChild(key);
        row.appendChild(bar);
        row.appendChild(meta);
        target.appendChild(row);
      }
    }

    async function refreshTrends() {
      const status = document.getElementById("trendStatus");
      const { apiUrl, secret, trendKeywords } = getConfig();
      const trendsApiUrl = getTrendsApiUrl(apiUrl);
      if (!trendsApiUrl || !secret) {
        status.textContent = "Configure le backend URL et le secret.";
        return;
      }

      status.textContent = "chargement...";
      localStorage.setItem(TREND_KEYWORDS_KEY, trendKeywords);
      const keywords = trendKeywords.split(",").map((k) => k.trim()).filter(Boolean).slice(0, 5);

      try {
        const res = await fetch(trendsApiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-agent-secret": secret },
          body: JSON.stringify({ keywords, geo: "FR", timeframe: "today 3-m" })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status} ${text.slice(0, 140)}`);
        }

        const data = await res.json();
        renderTrends(data);
        const fallbackInfo = data.fallbackReason ? ` | fallback: ${data.fallbackReason}` : "";
        status.textContent = `source: ${data.provider || "unknown"} | zone: ${data.geo || "FR"} | periode: ${data.timeframe || "today 3-m"}${fallbackInfo}`;
      } catch (err) {
        status.textContent = "signaux indisponibles pour le moment (source externe limitee).";
      }
    }

    async function autoSuggestKeywords(question) {
      const { apiUrl, secret } = getConfig();
      const suggestUrl = getKeywordSuggestApiUrl(apiUrl);
      if (!suggestUrl || !secret || !question) return;
      try {
        const res = await fetch(suggestUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-agent-secret": secret },
          body: JSON.stringify({ question, geo: "FR" })
        });
        if (!res.ok) return;
        const data = await res.json();
        const keywords = Array.isArray(data?.keywords) ? data.keywords.slice(0, 5) : [];
        if (keywords.length === 0) return;
        const merged = keywords.map((k) => String(k).trim()).filter(Boolean).join(", ");
        if (!merged) return;
        document.getElementById("trendKeywords").value = merged;
        localStorage.setItem(TREND_KEYWORDS_KEY, merged);
      } catch {
        // noop
      }
    }

    async function checkApi() {
      const el = document.getElementById("apiStatus");
      const { apiUrl, secret } = getConfig();
      el.classList.remove("ok", "err");

      if (!apiUrl) {
        el.textContent = "backend URL manquante";
        el.classList.add("err");
        return;
      }
      if (!secret) {
        el.textContent = "secret manquant";
        el.classList.add("err");
        return;
      }

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-agent-secret": secret },
          body: JSON.stringify({ messages: [{ role: "user", content: "ping" }] })
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status} | ${text.slice(0, 160)}`);
        }
        el.textContent = "connecte";
        el.classList.add("ok");
      } catch (err) {
        el.textContent = `non joignable (${err.message})`;
        el.classList.add("err");
      }
    }

    function extractInsights(text) {
      const lines = String(text || "").split("\n").map((l) => normalizeDisplayLine(l)).filter(Boolean);
      const facts = [];
      const hypotheses = [];
      const unknowns = [];
      const decisions = [];

      for (const line of lines) {
        if (line.includes("[Fact")) facts.push(line);
        if (line.includes("[Hypothesis")) hypotheses.push(line);
        if (line.includes("[Unknown")) unknowns.push(line);
        if (/option|decision|recommand|plan/i.test(line)) decisions.push(line);
      }

      return {
        facts: facts.slice(0, 6),
        hypotheses: hypotheses.slice(0, 6),
        unknowns: unknowns.slice(0, 6),
        decisions: decisions.slice(0, 6),
        sections: buildSectionListFromText(text).slice(0, 12)
      };
    }

    function renderInsights() {
      const title = document.getElementById("modeTitle");
      const sub = document.getElementById("modeSub");
      const stats = document.getElementById("progressStats");
      const stepper = document.getElementById("sectionStepper");
      const data = extractInsights(lastResponseText);
      stats.innerHTML = "";
      stepper.innerHTML = "";

      if (!lastResponseText) {
        const empty = document.createElement("p");
        empty.className = "muted-empty";
        empty.textContent = "Envoye une question pour alimenter cette vue.";
        stepper.appendChild(empty);
        return;
      }

      if (currentView === "diagnostic") {
        title.textContent = "Diagnostic";
        sub.textContent = "Ascenseur de lecture + comptage statut.";
      }

      if (currentView === "scenarios") {
        title.textContent = "Scenarios";
        sub.textContent = "Navigation rapide par sections detectees.";
      }

      if (currentView === "decision") {
        title.textContent = "Decision";
        sub.textContent = "Progression des parties orientees options et plan.";
      }

      const statValues = [
        { label: "Fact", value: data.facts.length },
        { label: "Hyp", value: data.hypotheses.length },
        { label: "Unknown", value: data.unknowns.length }
      ];

      statValues.forEach((s) => {
        const chip = document.createElement("div");
        chip.className = "stat-chip";
        chip.innerHTML = `<b>${s.value}</b><span>${s.label}</span>`;
        stats.appendChild(chip);
      });

      lastRenderedSections = data.sections.length > 0 ? data.sections : ["Introduction"];
      renderStepperFromLatestBubble();
    }

    function setTechnicalTrace(lines) {
      const target = document.getElementById("techTrace");
      if (!lines || lines.length === 0) {
        target.textContent = "Aucune execution pour le moment.";
        return;
      }

      target.innerHTML = lines.map((line) => {
        const [key, ...rest] = line.split(":");
        const value = rest.join(":").trim() || "-";
        return `<div class="tech-row"><span class="tech-key">${escapeHtml(key.trim())}</span><span class="tech-value">${escapeHtml(value)}</span></div>`;
      }).join("");
    }

    async function askAgent() {
      const questionInput = document.getElementById("question");
      const question = questionInput.value.trim();
      const { apiUrl, secret, detailMode } = getConfig();

      if (!question) return;
      if (!apiUrl || !secret) {
        appendMessage("assistant", "Configure d'abord le backend URL et le secret.");
        return;
      }

      appendMessage("user", question);
      questionInput.value = "";

      await autoSuggestKeywords(question);
      await refreshTrends();

      const typingMessage = { role: "assistant", content: "Analyse en cours..." };
      history.push(typingMessage);
      renderThread();

      try {
        const res = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-agent-secret": secret },
          body: JSON.stringify({
            messages: history.filter((m) => m !== typingMessage),
            detailMode,
            sessionId,
            clientApiUrl: apiUrl
          })
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status} ${res.statusText} | ${text.slice(0, 200)}`);
        }

        const data = await res.json();
        const answer = typeof data.response === "string" ? data.response : JSON.stringify(data, null, 2);

        const debugLines = [];
        if (data && typeof data === "object") {
          if ("model" in data) debugLines.push(`model: ${String(data.model)}`);
          if ("webSearchEnabled" in data) debugLines.push(`web_search_used: ${String(data.webSearchEnabled)}`);
          if ("fallback" in data) debugLines.push(`fallback: ${data.fallback ? String(data.fallback) : "none"}`);
          if ("promptVersion" in data) debugLines.push(`prompt_version: ${String(data.promptVersion)}`);

          if (data.airtableLog && typeof data.airtableLog === "object") {
            const a = data.airtableLog;
            debugLines.push(`airtable_enabled: ${String(Boolean(a.enabled))}`);
            debugLines.push(`airtable_ok: ${String(Boolean(a.ok))}`);
            if (a.status !== undefined) debugLines.push(`airtable_status: ${String(a.status)}`);
            if (typeof a.details === "string" && a.details.trim().length > 0) debugLines.push(`airtable_details: ${a.details.slice(0, 300)}`);
            if (typeof a.fieldMapTried === "string" && a.fieldMapTried.trim().length > 0) debugLines.push(`airtable_field_map: ${a.fieldMapTried}`);
          }

          if (data.promptVersionLog && typeof data.promptVersionLog === "object") {
            const p = data.promptVersionLog;
            debugLines.push(`prompt_log_enabled: ${String(Boolean(p.enabled))}`);
            debugLines.push(`prompt_log_ok: ${String(Boolean(p.ok))}`);
            if (typeof p.details === "string" && p.details.trim().length > 0) debugLines.push(`prompt_log_details: ${p.details.slice(0, 300)}`);
          }
        }

        history = history.filter((m) => m !== typingMessage);
        appendMessage("assistant", answer);
        lastResponseText = answer;
        renderInsights();
        setTechnicalTrace(debugLines);
      } catch (err) {
        history = history.filter((m) => m !== typingMessage);
        appendMessage("assistant", `Erreur appel agent: ${err.message}`);
      }
    }

    function initViewSwitch() {
      const root = document.getElementById("viewSwitch");
      root.addEventListener("click", (event) => {
        const btn = event.target.closest("button[data-view]");
        if (!btn) return;
        const view = btn.getAttribute("data-view");
        if (!view) return;

        currentView = view;
        for (const pill of root.querySelectorAll(".pill")) {
          pill.classList.toggle("active", pill === btn);
        }
        renderInsights();
      });
    }

    document.getElementById("question").addEventListener("keydown", (event) => {
      if ((event.ctrlKey || event.metaKey) && event.key === "Enter") {
        event.preventDefault();
        askAgent();
      }
    });
    document.getElementById("thread").addEventListener("scroll", () => {
      updateActiveStep();
    });

    loadConfig();
    loadSessionId();
    loadHistory();
    initViewSwitch();
    renderStarters();
    renderThread();
    renderInsights();
    checkApi();
    refreshTrends();
  </script>
</body>
</html>
